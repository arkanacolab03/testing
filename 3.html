<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <!-- Menggunakan Tailwind CSS v3 (Stabil) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          animation: {
            marquee: 'marquee 25s linear infinite',
            'fade-in': 'fadeIn 0.5s ease-out forwards',
            'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          },
          keyframes: {
            marquee: {
              '0%': { transform: 'translateX(100%)' },
              '100%': { transform: 'translateX(-100%)' },
            },
            fadeIn: {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            }
          }
        }
      }
    }
  </script>
  <style>
    /* Custom Scrollbar untuk Tabel */
    .custom-scrollbar::-webkit-scrollbar {
      height: 6px;
      width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    /* Glass Effect */
    .glass-panel {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }

    /* Hide Number Input Arrows */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    input[type=number] {
      -moz-appearance: textfield;
    }

    /* Skeleton Loading Class */
    .skeleton {
      background: #e2e8f0;
      background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 0.25rem;
    }
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
  <title>Cari Data Siswa</title>
</head>
<body class="h-screen flex flex-col bg-gradient-to-br from-slate-100 to-blue-100 font-sans text-slate-800 overflow-hidden relative">

  <!-- Background Decoration -->
  <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
    <div class="absolute -top-[10%] -left-[10%] w-[50%] h-[50%] rounded-full bg-blue-200 blur-3xl opacity-30"></div>
    <div class="absolute bottom-[10%] right-[10%] w-[40%] h-[40%] rounded-full bg-indigo-200 blur-3xl opacity-30"></div>
  </div>

  <!-- Header Logos -->
  <div class="absolute top-0 left-0 w-full p-4 sm:p-6 flex justify-between items-start pointer-events-none z-10">
    <img class="h-16 w-16 sm:h-20 sm:w-20 object-contain drop-shadow-md transition-transform hover:scale-105 pointer-events-auto" src="https://upload.wikimedia.org/wikipedia/commons/b/bd/Coat_of_arms_of_Central_Java.svg" alt="Logo Jawa Tengah"/>
    <!-- MODIFIKASI: Menghapus rounded-full agar logo kotak -->
    <img class="h-16 w-16 sm:h-20 sm:w-20 object-contain drop-shadow-md transition-transform hover:scale-105 pointer-events-auto" src="https://lh3.googleusercontent.com/d/1B5s362za0ESv2fYHpleiqDoxvw2MPSvR" alt="Logo Sekolah">
  </div>

  <!-- Logout Button (Authenticated User) -->
  <button id="logout-btn" onclick="logout()" type="button" class="hidden absolute top-4 right-20 sm:top-6 sm:right-32 z-50 bg-white/80 hover:bg-red-50 text-red-600 border border-red-100 shadow-sm hover:shadow-md px-3 py-1.5 rounded-full text-xs sm:text-sm font-medium transition-all duration-300 flex items-center gap-2 backdrop-blur-sm cursor-pointer">
    <i class="fa-solid fa-right-from-bracket"></i> <span class="hidden sm:inline">Logout</span>
  </button>

  <!-- MODIFIKASI: Login Button (Student Mode) -->
  <button id="login-mode-btn" onclick="backToLogin()" type="button" class="hidden absolute top-4 right-20 sm:top-6 sm:right-32 z-50 bg-white/80 hover:bg-blue-50 text-blue-600 border border-blue-100 shadow-sm hover:shadow-md px-3 py-1.5 rounded-full text-xs sm:text-sm font-medium transition-all duration-300 flex items-center gap-2 backdrop-blur-sm cursor-pointer">
    <i class="fa-solid fa-user-lock"></i> <span class="hidden sm:inline">Login Guru</span>
  </button>

  <!-- Main Content Container -->
  <main class="flex-1 w-full max-w-7xl mx-auto px-4 sm:px-6 flex flex-col justify-center items-center relative z-20 overflow-hidden py-16">
    
    <!-- AUTHENTICATION SECTION -->
    <section id="authentication-section" class="w-full max-w-sm overflow-y-auto max-h-full p-1 custom-scrollbar">
      
      <!-- Login Form -->
      <form id="login-form" class="hidden glass-panel rounded-2xl shadow-xl p-8 space-y-6 animate-fade-in border-t-4 border-blue-600">
        <div class="text-center space-y-2">
          <h2 class="text-2xl font-bold text-slate-800">Selamat Datang</h2>
          <p class="text-slate-500 text-sm">Silakan login untuk melanjutkan</p>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Username</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400"><i class="fa-regular fa-user"></i></span>
              <input maxlength="15" type="text" name="username" required placeholder="Masukkan username"
                class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all bg-white/50" />
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400"><i class="fa-solid fa-lock"></i></span>
              <input maxlength="255" type="password" name="password" required placeholder="••••••••"
                class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all bg-white/50" />
            </div>
          </div>
        </div>

        <button id="submit-btn" type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 rounded-lg shadow-lg shadow-blue-500/30 transition-all transform active:scale-95 flex justify-center items-center gap-2">
          <span>Masuk</span> <i class="fa-solid fa-arrow-right"></i>
        </button>

        <div class="text-center text-sm text-slate-600 space-y-2">
          <p>Belum punya akun? <span onclick="switchToSignUp(true)" class="text-blue-600 hover:text-blue-800 font-semibold cursor-pointer transition-colors">Daftar disini</span></p>
          <div class="flex items-center gap-2 justify-center opacity-75">
            <span class="h-px w-8 bg-slate-300"></span>
            <span class="text-xs text-slate-400">ATAU</span>
            <span class="h-px w-8 bg-slate-300"></span>
          </div>
          <p onclick="skipAuth()" class="text-slate-500 hover:text-blue-600 cursor-pointer transition-colors inline-flex items-center gap-1">
            Masuk sebagai <span class="font-semibold underline">Siswa</span>
          </p>
        </div>
      </form>

      <!-- Register Form -->
      <form id="register-form" class="hidden glass-panel rounded-2xl shadow-xl p-8 space-y-6 animate-fade-in border-t-4 border-indigo-600">
        <div class="text-center space-y-2">
          <h2 class="text-2xl font-bold text-slate-800">Buat Akun Baru</h2>
          <p class="text-slate-500 text-sm">Ajukan permohonan pendaftaran</p>
        </div>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Username</label>
            <input maxlength="15" type="text" name="username" required
              class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all bg-white/50"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
            <input maxlength="255" type="password" name="password" required
              class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all bg-white/50"/>
          </div>
        </div>

        <button id="submit-btn" type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 rounded-lg shadow-lg shadow-indigo-500/30 transition-all transform active:scale-95">
          Ajukan Permintaan
        </button>
        
        <p class="text-center text-sm text-slate-600">
          Sudah punya akun? <span onclick="switchToSignUp(false)" class="text-indigo-600 hover:text-indigo-800 font-semibold cursor-pointer">Login disini</span>
        </p>
      </form>
    </section>

    <!-- ADMIN SECTION -->
    <section id="admin-section" class="hidden w-full h-full flex flex-col animate-fade-in pt-4 pb-12">
      <div class="text-center mb-4 shrink-0">
        <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Admin Dashboard</h1>
        <div class="h-1 w-20 bg-blue-500 mx-auto mt-1 rounded-full"></div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 h-full min-h-0">
        <!-- Registered Users -->
        <div id="registered-user-container" class="glass-panel rounded-xl shadow-lg border border-slate-200 overflow-hidden flex flex-col h-full">
          <div class="bg-slate-50 border-b border-slate-200 p-3 shrink-0">
            <h2 class="text-base font-semibold text-slate-700 flex items-center gap-2">
              <i class="fa-solid fa-users text-blue-500"></i> User Terdaftar
            </h2>
          </div>
          <div class="p-3 flex-1 overflow-y-auto custom-scrollbar">
            <ul id="registered-user-list" class="space-y-2">
              <li class="grid grid-cols-12 gap-2 bg-slate-800 text-white text-xs font-semibold uppercase tracking-wider py-2 px-3 rounded-lg mb-2 sticky top-0 z-10 shadow-sm">
                <span class="col-span-1 text-center">No</span>
                <span class="col-span-8">Username</span>
                <span class="col-span-3 text-center">Aksi</span>
              </li>
              <div id="no-registered-user" class="hidden flex flex-col items-center justify-center py-12 text-slate-400">
                <i class="fa-regular fa-folder-open text-3xl mb-2"></i>
                <p>Tidak ada data</p>
              </div>
              <!-- Skeleton will be injected here initially -->
            </ul>
          </div>
        </div>

        <!-- User Requests -->
        <div id="request-user-container" class="glass-panel rounded-xl shadow-lg border border-slate-200 overflow-hidden flex flex-col h-full">
          <div class="bg-slate-50 border-b border-slate-200 p-3 shrink-0">
            <h2 class="text-base font-semibold text-slate-700 flex items-center gap-2">
              <i class="fa-solid fa-user-clock text-amber-500"></i> Permintaan Masuk
            </h2>
          </div>
          <div class="p-3 flex-1 overflow-y-auto custom-scrollbar">
            <ul id="request-user-list" class="space-y-2">
              <li class="grid grid-cols-12 gap-2 bg-slate-800 text-white text-xs font-semibold uppercase tracking-wider py-2 px-3 rounded-lg mb-2 sticky top-0 z-10 shadow-sm">
                <span class="col-span-1 text-center">No</span>
                <span class="col-span-7">Username</span>
                <span class="col-span-4 text-center">Aksi</span>
              </li>
              <div id="no-user-request" class="hidden flex flex-col items-center justify-center py-12 text-slate-400">
                <i class="fa-regular fa-circle-check text-3xl mb-2"></i>
                <p>Tidak ada permintaan</p>
              </div>
              <!-- Skeleton will be injected here initially -->
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- SEARCH FORM (SISWA) -->
    <form id="search-form" class="hidden glass-panel rounded-2xl shadow-xl p-6 sm:p-10 w-full max-w-lg space-y-6 animate-fade-in border-t-4 border-emerald-500 my-auto">
      <div class="text-center">
        <h3 class="text-2xl font-bold text-slate-800">Cari Data Siswa</h3>
        <p class="text-slate-500 text-sm mt-1">Masukkan NISN dan Tanggal Lahir</p>
      </div>

      <div class="space-y-4">
        <div>
          <label for="nisn" class="block text-sm font-medium text-slate-700 mb-1">NISN</label>
          <input maxlength="10" id="nisn" required placeholder="Nomor Induk Siswa Nasional"
            class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none transition-all bg-white/50 text-slate-800 tracking-wide"/>
        </div>

        <div>
          <label for="tgl" class="block text-sm font-medium text-slate-700 mb-1">Tanggal Lahir</label>
          <input type="date" id="tgl" required
            class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none transition-all bg-white/50 text-slate-800"/>
        </div>
      </div>

      <input id="search-btn" type="submit" value="Cari Siswa"
        class="w-full py-3 rounded-lg bg-emerald-600 text-white font-semibold hover:bg-emerald-700 shadow-lg shadow-emerald-500/30 cursor-pointer transition-all transform active:scale-95"/>
    </form>

    <!-- DATA RESULT SECTION -->
    <section id="data-section" class="hidden glass-panel rounded-2xl shadow-xl w-full max-w-5xl h-full max-h-[calc(100vh-80px)] flex flex-col p-4 sm:p-5 animate-fade-in relative z-20">
      
      <!-- Header Section -->
      <div class="flex justify-between items-center mb-3 shrink-0">
        <h3 class="text-lg sm:text-xl font-bold text-slate-800 border-l-4 border-blue-500 pl-3">Hasil Pencarian</h3>
        <button onclick="backToSearch()" class="px-3 py-1.5 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-full text-xs sm:text-sm font-medium transition-colors flex items-center gap-1.5">
          <i class="fa-solid fa-arrow-left"></i> Kembali
        </button>
      </div>
      
      <!-- Student Info Grid -->
      <div class="bg-white/60 rounded-xl p-3 mb-3 grid grid-cols-2 md:grid-cols-3 gap-2 text-xs sm:text-sm border border-slate-100 shadow-sm shrink-0">
        <div class="flex flex-col"><span class="text-[10px] text-slate-500 uppercase tracking-wider">Nama</span><span id="nama" class="font-semibold text-slate-800 truncate min-h-[1.5em]"></span></div>
        <div class="flex flex-col"><span class="text-[10px] text-slate-500 uppercase tracking-wider">NISN</span><span id="nisn2" class="font-mono font-medium text-slate-700 min-h-[1.5em]"></span></div>
        <div class="flex flex-col"><span class="text-[10px] text-slate-500 uppercase tracking-wider">Kelas</span><span id="kelas" class="font-medium text-slate-700 min-h-[1.5em]"></span></div>
        <div class="flex flex-col"><span class="text-[10px] text-slate-500 uppercase tracking-wider">NIS</span><span id="nis" class="font-mono font-medium text-slate-700 min-h-[1.5em]"></span></div>
        <div class="flex flex-col md:col-span-2"><span class="text-[10px] text-slate-500 uppercase tracking-wider">Email</span><span id="email" class="font-medium text-slate-700 truncate min-h-[1.5em]"></span></div>
      </div>

      <!-- Table Container -->
      <div class="flex-1 overflow-auto custom-scrollbar rounded-lg border border-slate-200 shadow-sm bg-white min-h-0 relative">
        <table class="w-full text-xs text-left min-w-[600px] relative">
          <thead class="bg-slate-800 text-white uppercase text-[10px] font-semibold tracking-wider sticky top-0 z-10 shadow-sm">
            <tr>
              <th class="p-2 text-center w-12">Smt</th>
              <th class="p-2 text-center">B. Indo</th>
              <th class="p-2 text-center">B. Ing</th>
              <th class="p-2 text-center">Mat</th>
              <th class="p-2 text-center">IPA</th>
              <th class="p-2 text-center">Inf</th>
              <th class="p-2 text-center w-16 bg-slate-900">Rata²</th>
            </tr>
          </thead>
          <tbody id="tbl" class="divide-y divide-slate-100">
            <!-- rows generated via JS -->
          </tbody>
        </table>
      </div>

      <!-- Footer Section -->
      <div class="mt-3 flex flex-col gap-2 shrink-0">
        <div id="status" class="py-2 px-3 rounded-lg bg-blue-50 border border-blue-100 text-center font-semibold text-blue-800 text-xs sm:text-sm transition-all min-h-[2.5em]">
          Menunggu perhitungan...
        </div>

        <button id="save-btn" onclick="save()"
          class="w-full py-2.5 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 shadow-md shadow-blue-500/30 cursor-pointer transition-all transform active:scale-[0.98] flex justify-center items-center gap-2">
          <i class="fa-solid fa-floppy-disk"></i> Simpan
        </button>
      </div>
    </section>

  </main>

  <!-- Footer (Fixed Bottom) -->
  <footer class="fixed bottom-0 w-full z-50 bg-blue-600/90 backdrop-blur-md text-white py-1.5 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
    <div class="overflow-hidden relative w-full flex items-center h-5">
      <div class="animate-marquee whitespace-nowrap absolute">
        <span class="mx-4 text-xs font-medium tracking-wide">Aplikasi ini dibuat oleh Arkana Faisal Ridho kelas 12F-7 Absen 3 @2026</span>
        <span class="mx-4 text-xs font-medium tracking-wide opacity-50">|</span>
        <span class="mx-4 text-xs font-medium tracking-wide">Gunakan dengan bijak</span>
        <span class="mx-4 text-xs font-medium tracking-wide opacity-50">|</span>
        <span class="mx-4 text-xs font-medium tracking-wide">Aplikasi ini dibuat oleh Arkana Faisal Ridho kelas 12F-7 Absen 3 @2026</span>
      </div>
    </div>
  </footer>

  <!-- Toast Notification -->
  <div id="alertBox" class="fixed top-6 left-1/2 -translate-x-1/2 z-[100] hidden min-w-[300px] max-w-md rounded-xl px-6 py-4 shadow-2xl transition-all duration-300 flex items-center gap-3 border border-white/20 backdrop-blur-md">
    <i id="alertIcon" class="text-xl"></i>
    <span id="alertMsg" class="font-medium text-sm"></span>
  </div>

  <!-- MODIFIKASI: Confirmation Modal -->
  <div id="confirmModal" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-fade-in">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full border border-slate-200">
      <div class="text-center mb-6">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
          <i class="fa-solid fa-triangle-exclamation text-red-600 text-xl"></i>
        </div>
        <h3 class="text-lg font-bold text-slate-900">Konfirmasi Hapus</h3>
        <p class="text-sm text-slate-500 mt-2">Apakah Anda yakin ingin menghapus user ini? Tindakan ini tidak dapat dibatalkan.</p>
      </div>
      <div class="flex gap-3 justify-center">
        <button onclick="closeConfirm()" class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-medium transition-colors">
          Batal
        </button>
        <button id="confirmBtn" class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium shadow-md shadow-red-500/30 transition-colors">
          Ya, Hapus
        </button>
      </div>
    </div>
  </div>

  <!-- Templates -->
  <template id="registered-user-node-template">
    <li id="request-user-node" class="grid grid-cols-12 gap-2 bg-white hover:bg-slate-50 border-b border-slate-100 py-3 px-3 rounded-lg items-center transition-colors text-sm">
      <h4 class="col-span-1 text-center font-mono text-slate-500">1</h4>
      <h4 class="col-span-8 truncate font-medium text-slate-700 px-2">username</h4>
      <h4 class="col-span-3 flex justify-center">
        <!-- MODIFIKASI: Mengubah onclick ke openConfirm -->
        <button onclick="openConfirm(this)" class="bg-red-100 hover:bg-red-200 text-red-600 rounded-lg p-1.5 transition-colors" title="Hapus User">
          <i class="fa-solid fa-trash-can"></i>
        </button>
      </h4>
    </li>
  </template>

  <template id="request-user-node-template">
    <li id="request-user-node" class="grid grid-cols-12 gap-2 bg-white hover:bg-slate-50 border-b border-slate-100 py-3 px-3 rounded-lg items-center transition-colors text-sm">
      <h4 class="col-span-1 text-center font-mono text-slate-500">1</h4>
      <h4 class="col-span-7 truncate font-medium text-slate-700 px-2">username</h4>
      <h4 class="col-span-4 flex justify-center gap-2">
        <button onclick="requestUserHandler(this, true)" class="bg-emerald-100 hover:bg-emerald-200 text-emerald-600 rounded-lg p-1.5 transition-colors" title="Terima">
          <i class="fa-solid fa-check"></i>
        </button>
        <button onclick="requestUserHandler(this, false)" class="bg-red-100 hover:bg-red-200 text-red-600 rounded-lg p-1.5 transition-colors" title="Tolak">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </h4>
    </li>
  </template>

  <template id="row-template">
    <tr class="hover:bg-blue-50/50 transition-colors group">
      <td class="p-1.5 text-center border-r border-slate-100 font-semibold text-slate-600 semester bg-slate-50/50"></td>
      <td class="p-1"><input class="w-full text-center p-1.5 rounded focus:bg-white focus:ring-2 focus:ring-blue-400 focus:outline-none bg-transparent transition-all font-medium text-slate-700 placeholder-slate-300 text-xs" type="number" placeholder="0" /></td>
      <td class="p-1"><input class="w-full text-center p-1.5 rounded focus:bg-white focus:ring-2 focus:ring-blue-400 focus:outline-none bg-transparent transition-all font-medium text-slate-700 placeholder-slate-300 text-xs" type="number" placeholder="0" /></td>
      <td class="p-1"><input class="w-full text-center p-1.5 rounded focus:bg-white focus:ring-2 focus:ring-blue-400 focus:outline-none bg-transparent transition-all font-medium text-slate-700 placeholder-slate-300 text-xs" type="number" placeholder="0" /></td>
      <td class="p-1"><input class="w-full text-center p-1.5 rounded focus:bg-white focus:ring-2 focus:ring-blue-400 focus:outline-none bg-transparent transition-all font-medium text-slate-700 placeholder-slate-300 text-xs" type="number" placeholder="0" /></td>
      <td class="p-1"><input class="w-full text-center p-1.5 rounded focus:bg-white focus:ring-2 focus:ring-blue-400 focus:outline-none bg-transparent transition-all font-medium text-slate-700 placeholder-slate-300 text-xs" type="number" placeholder="0" /></td>
      <td class="p-1.5 text-center font-bold text-blue-600 avg bg-slate-50/30"></td>
    </tr>
  </template>

  <!-- MODIFIKASI: Skeleton Templates -->
  <template id="skeleton-row-admin">
    <li class="grid grid-cols-12 gap-2 bg-white border-b border-slate-100 py-3 px-3 rounded-lg items-center">
        <div class="col-span-1 skeleton h-4 w-4 mx-auto rounded"></div>
        <div class="col-span-7 skeleton h-4 w-24 rounded"></div>
        <div class="col-span-4 flex justify-center gap-2">
            <div class="skeleton h-6 w-6 rounded"></div>
            <div class="skeleton h-6 w-6 rounded"></div>
        </div>
    </li>
  </template>

  <template id="skeleton-row-table">
    <tr class="border-b border-slate-50">
      <td class="p-2"><div class="skeleton h-6 w-full rounded"></div></td>
      <td class="p-2"><div class="skeleton h-8 w-full rounded"></div></td>
      <td class="p-2"><div class="skeleton h-8 w-full rounded"></div></td>
      <td class="p-2"><div class="skeleton h-8 w-full rounded"></div></td>
      <td class="p-2"><div class="skeleton h-8 w-full rounded"></div></td>
      <td class="p-2"><div class="skeleton h-8 w-full rounded"></div></td>
      <td class="p-2"><div class="skeleton h-8 w-full rounded"></div></td>
    </tr>
  </template>

<script>
//variable (Logic remains identical)
const loginForm = document.getElementById("login-form")
const submitLoginForm = loginForm.querySelector("#submit-btn")
const registerForm = document.getElementById("register-form")
const submitRegisterForm = registerForm.querySelector("#submit-btn")
const searchForm = document.getElementById("search-form")
const adminSection = document.getElementById("admin-section")
const dataSection = document.getElementById("data-section")
let currentNISN = "";
const searchBtn = searchForm.querySelector("#search-btn")
const logoutBtn = document.getElementById("logout-btn")
const loginModeBtn = document.getElementById("login-mode-btn") // New Button

// authorization logic
checkSession()
function checkSession(){
  const token = localStorage.getItem("token")
  if(!token){return loginForm.classList.remove("hidden")}

  google.script.run.withSuccessHandler(res =>{
    if(!res.success){
      loginForm.classList.remove("hidden")
      showAlert(res.message, "warning")
      return
    }

    loginForm.classList.add("hidden")
    logoutBtn.classList.remove("hidden")
    showAlert(res.message, "info")

    if(res.role === "admin"){
      adminSection.classList.remove("hidden")
      setAdminSection()
      return
    }

    searchForm.classList.remove("hidden")
  
  }).login(null, null, token)
}

loginForm.addEventListener("submit", e => {
  e.preventDefault()
  setSubmitDisabled(submitLoginForm, true, "Masuk")

  const username = loginForm.elements.username.value.trim()
  const password = loginForm.elements.password.value.trim()

  google.script.run.withSuccessHandler(res =>{
    setSubmitDisabled(submitLoginForm, false, "Masuk")
    if(!res.success){return showAlert(res.message, "warning")}

    localStorage.setItem("token", res.token)
    loginForm.reset()
    loginForm.classList.add("hidden")
    logoutBtn.classList.remove("hidden")
    showAlert(res.message, "info")
    if(res.role === "admin"){
      adminSection.classList.remove("hidden")
      setAdminSection()
      return
    }

    searchForm.classList.remove("hidden")
  }).withFailureHandler(err => {
    setSubmitDisabled(submitLoginForm, false, "Masuk")
    showAlert("server error", "error")
  }).login(username, password)
})

registerForm.addEventListener("submit", e =>{
  e.preventDefault()
  setSubmitDisabled(submitRegisterForm, true, "Ajukan Permintaan")

  const username = registerForm.elements.username.value.trim()
  const password = registerForm.elements.password.value.trim()

  google.script.run.withSuccessHandler(res =>{
    setSubmitDisabled(submitRegisterForm, false, "Ajukan Permintaan")
    if(!res.ok){return showAlert(res.message, "error")}

    showAlert(res.message)
    // Optional: Switch back to login after success register
    // switchToSignUp(false)
  }).withFailureHandler(err => {
    setSubmitDisabled(submitRegisterForm, false, "Ajukan Permintaan")
    showAlert("server error", "error")
  }).register(username, password)
})

function logout(){
  localStorage.removeItem("token")
  logoutBtn.classList.add("hidden")
  
  loginForm.classList.remove("hidden")
  searchForm.classList.add("hidden")
  dataSection.classList.add("hidden")
  adminSection.classList.add("hidden")
  
  // Reset forms
  loginForm.reset();
  searchForm.reset();
}

function switchToSignUp(isTrue){
  if(isTrue){
    loginForm.classList.add("hidden")
    registerForm.classList.remove("hidden")
    return
  }
  registerForm.classList.add("hidden")
  loginForm.classList.remove("hidden")

}

// MODIFIKASI: Menambahkan tombol login saat mode siswa
function skipAuth(){
  loginForm.classList.add("hidden")
  searchForm.classList.remove("hidden")
  loginModeBtn.classList.remove("hidden")
}

// MODIFIKASI: Fungsi kembali ke login untuk mode siswa
function backToLogin(){
    loginModeBtn.classList.add("hidden")
    searchForm.classList.add("hidden")
    dataSection.classList.add("hidden")
    searchForm.reset();
    loginForm.classList.remove("hidden")
}

// Admin logic
const registeredList = document.getElementById("registered-user-list")
const requestList = document.getElementById("request-user-list")
const noRegisteredList = document.getElementById("no-registered-user")
const noRequestList = document.getElementById("no-user-request")
const registeredNode = document.getElementById("registered-user-node-template").content.firstElementChild
const requestNode = document.getElementById("request-user-node-template").content.firstElementChild
// MODIFIKASI: Skeleton Logic
const skeletonAdmin = document.getElementById("skeleton-row-admin").content;

function setAdminSection(){
  // Tampilkan skeleton sebelum fetch
  showAdminSkeletons();

  google.script.run.withSuccessHandler(res => {
    const {users, requests} = res
    
    // Hapus Skeletons (sisakan header)
    cleanList(registeredList);
    cleanList(requestList);
    
    if(users.length > 0){
      noRegisteredList.classList.add("hidden")
      const fragment = document.createDocumentFragment()

      for(let i=0;i<users.length;i++){
        const newEl = registeredNode.cloneNode(true)
        newEl.dataset.username = users[i][0]
        newEl.querySelector('h4:nth-child(1)').innerText = i + 1; 
        newEl.children[1].innerText = users[i][0]
        fragment.appendChild(newEl)
      }
      registeredList.appendChild(fragment)
    } else {
        noRegisteredList.classList.remove("hidden")
    }

    if(requests.length > 0){
      noRequestList.classList.add("hidden")
      const fragment = document.createDocumentFragment()

      for(let i=0;i<requests.length;i++){
        const newEl = requestNode.cloneNode(true)
        newEl.dataset.id = requests[i][1]
        newEl.querySelector('h4:nth-child(1)').innerText = i + 1; 
        newEl.children[1].innerText = requests[i][0]
        fragment.appendChild(newEl)
      }
      requestList.appendChild(fragment)
    } else {
        noRequestList.classList.remove("hidden")
    }
  }).withFailureHandler(err => {
    showAlert("server error", "error")
    // Bersihkan skeleton jika error
    cleanList(registeredList);
    cleanList(requestList);
  }).getUserList()
}

function showAdminSkeletons(){
    // Bersihkan list (sisakan header)
    cleanList(registeredList);
    cleanList(requestList);
    noRegisteredList.classList.add("hidden");
    noRequestList.classList.add("hidden");

    // Add 3 skeletons to each
    for(let i=0; i<3; i++){
        registeredList.appendChild(skeletonAdmin.cloneNode(true));
        requestList.appendChild(skeletonAdmin.cloneNode(true));
    }
}

function cleanList(listElement){
    while(listElement.children.length > 1) { // 1 is header
        listElement.removeChild(listElement.lastChild);
    }
}

function requestUserHandler(el, isApproved){
  const root = el.closest("#request-user-node")
  const registerId = root.dataset.id
  
  google.script.run.withSuccessHandler(res => {
    if(res.ok){
      showAlert(res.message)
      root.remove()
      if(requestList.querySelectorAll('li').length <= 1){ 
          noRequestList.classList.remove("hidden")
      }

      if(isApproved){
        const newEl = registeredNode.cloneNode(true)
        newEl.dataset.username = root.children[1].innerText
        const count = registeredList.querySelectorAll('li').length;
        newEl.querySelector('h4:nth-child(1)').innerText = count;
        newEl.children[1].innerText = root.children[1].innerText
        registeredList.appendChild(newEl)
        noRegisteredList.classList.add("hidden")
      }
      return
    }

    showAlert(res.message, "error")
  }).withFailureHandler(err => {
    showAlert("server error", "error")
  }).setRequestUser(localStorage.getItem("token"), registerId, isApproved)
}

// MODIFIKASI: Global variable untuk user yang akan dihapus
let userToDeleteEl = null;

function openConfirm(el) {
    userToDeleteEl = el;
    document.getElementById("confirmModal").classList.remove("hidden");
}

function closeConfirm() {
    userToDeleteEl = null;
    document.getElementById("confirmModal").classList.add("hidden");
}

// Event listener untuk tombol Ya di modal
document.getElementById("confirmBtn").addEventListener("click", () => {
    if(userToDeleteEl) {
        removeUser(userToDeleteEl);
        closeConfirm();
    }
});

function removeUser(el){
  const root = el.closest("#request-user-node") 
  const username = root.dataset.username

  google.script.run.withSuccessHandler(res => {
    if(res.ok){
      showAlert(res.message)
      root.remove()
       if(registeredList.querySelectorAll('li').length <= 1){
         noRegisteredList.classList.remove("hidden")
       }
      return
    }

    showAlert(res.message, "error")
  }).withFailureHandler(err => {
    showAlert("server error", "error")
  }).removeUser(localStorage.getItem("token"), username)
}

// main logic
searchForm.addEventListener("submit", e => {
  e.preventDefault()
  setSubmitDisabled(searchBtn, true, "Cari Siswa")

  const nisn = document.getElementById("nisn").value;
  const tgl = document.getElementById("tgl").value;
  
  // MODIFIKASI: Show Skeleton before searching
  showSearchSkeleton();

  google.script.run.withSuccessHandler(res=>{
    setSubmitDisabled(searchBtn, false, "Cari Siswa")
    if(!res){
      showAlert("Data tidak ditemukan", "info")
      // Kembalikan tampilan ke search form jika gagal
      backToSearch(); 
      return
    }
    showAlert("Data ditemukan", "success")

    currentNISN = res.siswa.nisn

    document.getElementById("nama").innerText=res.siswa.nama;
    document.getElementById("nisn2").innerText= currentNISN
    document.getElementById("nis").innerText=res.siswa.nis;
    document.getElementById("kelas").innerText=res.siswa.kelas;
    document.getElementById("email").innerText=res.siswa.email;

    const template = document.getElementById("row-template");
    const tbody = document.getElementById("tbl");
    tbody.innerHTML = "";

    for(let s=1; s<=5; s++){
      let n = res.nilai[s];
      const clone = template.content.cloneNode(true);
      clone.querySelector(".semester").textContent = "SMT " + s;
      const inputs = clone.querySelectorAll("input");
      inputs[0].value = n[0];
      inputs[1].value = n[1];
      inputs[2].value = n[2];
      inputs[3].value = n[3];
      inputs[4].value = n[4];
      tbody.appendChild(clone);
    }
    
    // Enable Save Button (it might be disabled by default logic, but just in case)
    document.getElementById("save-btn").disabled = false;
    document.getElementById("save-btn").classList.remove("opacity-70");
    document.getElementById("status").classList.remove("skeleton", "text-transparent");

    addInputListeners()
    initCalculate()

  }).getDataSiswa(nisn,tgl);
})

function showSearchSkeleton() {
    searchForm.classList.add("hidden");
    dataSection.classList.remove("hidden");
    
    // Set info fields to skeleton
    const fields = ["nama", "nisn2", "nis", "kelas", "email"];
    fields.forEach(id => {
        const el = document.getElementById(id);
        el.innerHTML = '<div class="skeleton h-4 w-full rounded"></div>';
    });
    
    // Set table to skeleton
    const tbody = document.getElementById("tbl");
    tbody.innerHTML = "";
    const skelRow = document.getElementById("skeleton-row-table").content;
    for(let i=0; i<5; i++){
        tbody.appendChild(skelRow.cloneNode(true));
    }
    
    // Set Status and Save button loading state visually
    const statusEl = document.getElementById("status");
    statusEl.innerHTML = "";
    statusEl.className = "skeleton h-10 w-full rounded-lg";
}

const saveBtn = document.getElementById("save-btn")
function save(){
  const token = localStorage.getItem("token")
  if(!token){return showAlert("Login sebagai Guru/Admin untuk menyimpan", "error")}

  setSubmitDisabled(saveBtn, true, "Simpan")
  let inputs=document.querySelectorAll("#tbl tr input");
  let data = [];
  let isInvalid = false
  let invalidValue = null
  
  inputs.forEach((input)=>{
    const value = Number(input.value)
    if(value < 0 || value > 100){
      isInvalid = true
      invalidValue = value
      return
    }
    data.push(value)
  });

  if(isInvalid){
    showAlert(`Nilai ${invalidValue} tidak valid (0-100)`, "warning")
    setSubmitDisabled(saveBtn, false, "Simpan")
    return
  }

  google.script.run.withSuccessHandler((res)=>{
    if(!res){
        setSubmitDisabled(saveBtn, false, "Simpan")
        return showAlert("Gagal menyimpan data", "error")
    }

    showAlert("Data berhasil disimpan", "success")
    setSubmitDisabled(saveBtn, false, "Simpan")
  }).withFailureHandler(err => {
    setSubmitDisabled(saveBtn, false, "Simpan")
    showAlert("server error", "error")
  }).saveData(token, currentNISN,[data]);
}

function addInputListeners(){
  document.querySelectorAll("#tbl tr").forEach(row=>{
    row.querySelectorAll("input").forEach(input=>{
      input.onchange = () => {
        let inputs = row.querySelectorAll("input");
        let sum = 0;
        inputs.forEach(i=>sum += Number(i.value||0));
        let avg = sum / inputs.length;
        row.children[row.children.length - 1].innerText = avg.toFixed(2);
        updateStatus();
      }
      // Add visual active state to row
      input.addEventListener('focus', () => row.classList.add('bg-blue-50'));
      input.addEventListener('blur', () => row.classList.remove('bg-blue-50'));
    });
  });
}

function initCalculate() {
  document.querySelectorAll("#tbl tr").forEach(row => {
    const inputs = row.querySelectorAll("input");
    let sum = 0;
    inputs.forEach(i => sum += Number(i.value || 0));
    const avg = sum / inputs.length;
    row.children[row.children.length - 1].innerText = avg.toFixed(2);
  });
  updateStatus();
}

function updateStatus(){
  let rows = document.querySelectorAll("#tbl tr");
  let total = 0, count = 0;
  rows.forEach(r=>{
    let avgText = r.children[r.children.length - 1].innerText;
    let avg = parseFloat(avgText) || 0;
    total += avg;
    count++;
  });
  let akhir = total/count;
  let status="TIDAK LULUS";
  let colorClass = "text-red-600 bg-red-100 border-red-200";
  
  if(akhir>=92) {
      status="LULUS (MEMUASKAN)";
      colorClass = "text-emerald-700 bg-emerald-100 border-emerald-200";
  }
  else if(akhir>=78) {
      status="LULUS";
      colorClass = "text-blue-700 bg-blue-100 border-blue-200";
  }
  
  const statusEl = document.getElementById("status");
  statusEl.innerText = `Rata-rata Akhir: ${akhir.toFixed(2)} — ${status}`;
  statusEl.className = `py-2 px-3 rounded-lg border text-center font-bold text-xs sm:text-sm transition-all shadow-sm ${colorClass}`;
}

function showAlert(msg, type = "success", timeout = 3000) {
  const el = document.getElementById("alertBox");
  const msgEl = document.getElementById("alertMsg");
  const iconEl = document.getElementById("alertIcon");

  // Reset basic classes
  el.className = "fixed top-6 left-1/2 -translate-x-1/2 z-[100] min-w-[300px] max-w-md rounded-xl px-6 py-4 shadow-2xl transition-all duration-300 flex items-center gap-3 border backdrop-blur-md translate-y-[-20px] opacity-0";

  const configs = {
    success: { class: "bg-emerald-500/90 text-white border-emerald-400", icon: "fa-circle-check" },
    error:   { class: "bg-red-500/90 text-white border-red-400", icon: "fa-circle-exclamation" },
    warning: { class: "bg-amber-500/90 text-white border-amber-400", icon: "fa-triangle-exclamation" },
    info:    { class: "bg-blue-500/90 text-white border-blue-400", icon: "fa-circle-info" }
  };

  const config = configs[type] || configs.info;
  
  el.classList.add(...config.class.split(" "));
  iconEl.className = `fa-solid ${config.icon} text-xl`;
  msgEl.textContent = msg;

  el.classList.remove("hidden");
  // Trigger reflow
  void el.offsetWidth;
  el.classList.remove("translate-y-[-20px]", "opacity-0");
  el.classList.add("translate-y-0", "opacity-100");

  clearTimeout(el._t);
  el._t = setTimeout(() => {
    el.classList.replace("translate-y-0", "translate-y-[-20px]");
    el.classList.replace("opacity-100", "opacity-0");
    setTimeout(() => el.classList.add("hidden"), 300);
  }, timeout);
}

function setSubmitDisabled(el, isDisabled, originalText) {
  el.disabled = isDisabled;

  if (isDisabled) {
    el.classList.add("opacity-70", "cursor-not-allowed");
    el.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Loading...`;
  } else {
    el.classList.remove("opacity-70", "cursor-not-allowed");
    // Restore original text based on context if simpler, or just pass generic
    if(originalText) el.innerHTML = originalText;
    else el.innerHTML = el.value; 
  }
}

function backToSearch(){
  searchForm.classList.remove("hidden")
  dataSection.classList.add("hidden");
}
</script>
</body>
</html>
